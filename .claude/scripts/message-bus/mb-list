#!/bin/bash
# mb-list - List orchestrators registered with the message bus
# Usage: mb-list [--all] [--json]
#
# Options:
#   --all   Include stopped orchestrators
#   --json  Output in JSON format

set -e

DB_FILE="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/queue.db"
ALL=false
JSON=false

for arg in "$@"; do
    case $arg in
        --all)
            ALL=true
            ;;
        --json)
            JSON=true
            ;;
    esac
done

# Ensure DB exists
if [ ! -f "$DB_FILE" ]; then
    echo "Error: Message bus not initialized. Run mb-init first."
    exit 1
fi

WHERE_CLAUSE="WHERE status='active'"
[ "$ALL" = true ] && WHERE_CLAUSE=""

if [ "$JSON" = true ]; then
    sqlite3 -json "$DB_FILE" "
        SELECT instance_id, tmux_session, description, initiative, status,
               strftime('%Y-%m-%d %H:%M', registered_at) as registered,
               strftime('%Y-%m-%d %H:%M', last_heartbeat) as last_seen
        FROM orchestrators $WHERE_CLAUSE
        ORDER BY last_heartbeat DESC
    " 2>/dev/null || echo "[]"
else
    COUNT=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM orchestrators $WHERE_CLAUSE" 2>/dev/null || echo "0")

    if [ "$COUNT" = "0" ]; then
        echo "No active orchestrators registered"
        exit 0
    fi

    echo "=== Orchestrators ($COUNT) ==="
    echo ""
    sqlite3 -column -header "$DB_FILE" "
        SELECT
            instance_id as 'Instance',
            tmux_session as 'tmux',
            substr(description, 1, 30) as 'Description',
            initiative as 'Initiative',
            status as 'Status',
            strftime('%H:%M', last_heartbeat) as 'Last Seen'
        FROM orchestrators $WHERE_CLAUSE
        ORDER BY last_heartbeat DESC
    " 2>/dev/null
fi
