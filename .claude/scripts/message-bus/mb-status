#!/bin/bash
# mb-status - Show message bus status
# Usage: mb-status

set -e

DB_FILE="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/queue.db"
SIGNAL_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/signals"

# Ensure DB exists
if [ ! -f "$DB_FILE" ]; then
    echo "Message bus not initialized. Run: mb-init"
    exit 1
fi

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║                    MESSAGE BUS STATUS                          ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

# Pending messages
PENDING_TOTAL=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM messages WHERE read_at IS NULL" 2>/dev/null || echo "0")
echo "📬 Pending Messages: $PENDING_TOTAL"

if [ "$PENDING_TOTAL" != "0" ]; then
    echo ""
    sqlite3 "$DB_FILE" "
        SELECT '   ' || COALESCE(to_instance, 'broadcast') || ': ' || COUNT(*) || ' message(s)'
        FROM messages
        WHERE read_at IS NULL
        GROUP BY to_instance
    " 2>/dev/null
fi

echo ""

# Active orchestrators
ORCH_COUNT=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM orchestrators WHERE status='active'" 2>/dev/null || echo "0")
echo "🤖 Active Orchestrators: $ORCH_COUNT"

if [ "$ORCH_COUNT" != "0" ]; then
    echo ""
    sqlite3 "$DB_FILE" "
        SELECT '   ' || instance_id || ' (' || tmux_session || ') - ' || COALESCE(initiative, 'no initiative')
        FROM orchestrators
        WHERE status='active'
        ORDER BY last_heartbeat DESC
    " 2>/dev/null
fi

echo ""

# Signal files
SIGNAL_COUNT=$(ls -1 "$SIGNAL_DIR"/*.signal 2>/dev/null | wc -l | tr -d ' ')
echo "🚨 Active Signals: $SIGNAL_COUNT"

if [ "$SIGNAL_COUNT" != "0" ]; then
    echo ""
    for sig in "$SIGNAL_DIR"/*.signal; do
        [ -f "$sig" ] && echo "   $(basename "$sig" .signal)"
    done
fi

echo ""

# Recent activity
echo "📋 Recent Activity (last 5):"
echo ""
sqlite3 "$DB_FILE" "
    SELECT '   [' || strftime('%H:%M:%S', timestamp) || '] ' || event || ' - ' || instance_id
    FROM message_log
    ORDER BY timestamp DESC
    LIMIT 5
" 2>/dev/null || echo "   (no activity logged)"

echo ""
echo "═══════════════════════════════════════════════════════════════════"
