#!/bin/bash
# mb-unregister - Unregister an orchestrator from the message bus
# Usage: mb-unregister <instance-id>

set -e

INSTANCE_ID="$1"

if [ -z "$INSTANCE_ID" ]; then
    echo "Usage: mb-unregister <instance-id>"
    exit 1
fi

DB_FILE="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/queue.db"
SIGNAL_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/signals"

# Ensure DB exists
if [ ! -f "$DB_FILE" ]; then
    echo "Error: Message bus not initialized."
    exit 1
fi

# Update status to stopped
sqlite3 "$DB_FILE" "UPDATE orchestrators SET status='stopped' WHERE instance_id='$INSTANCE_ID'"

# Log unregistration
sqlite3 "$DB_FILE" "INSERT INTO message_log (event, instance_id, details)
    VALUES ('unregistered', '$INSTANCE_ID', 'stopped')"

# Clean up signal files
rm -f "$SIGNAL_DIR/${INSTANCE_ID}.signal" "$SIGNAL_DIR/${INSTANCE_ID}.msg" 2>/dev/null || true

echo "Unregistered: $INSTANCE_ID"
