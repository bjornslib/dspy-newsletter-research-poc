#!/bin/bash
# mb-send - Send a message to an orchestrator or broadcast to all
# Usage: mb-send <to> <type> <payload> [--urgent] [--priority=N]
#        mb-send --broadcast <type> <payload> [--urgent]
#
# Examples:
#   mb-send orch-epic4 guidance '{"subject":"Focus shift","body":"Prioritize API"}'
#   mb-send --broadcast announcement '{"subject":"Policy","body":"Tests required"}'
#   mb-send orch-epic4 urgent '{"subject":"Stop","body":"Regression found"}' --urgent

set -e

# Defaults
URGENT=false
PRIORITY=5
BROADCAST=false
TO=""
TYPE=""
PAYLOAD=""

# Parse arguments
POSITIONAL=()
for arg in "$@"; do
    case $arg in
        --urgent)
            URGENT=true
            PRIORITY=1
            ;;
        --broadcast)
            BROADCAST=true
            ;;
        --priority=*)
            PRIORITY="${arg#*=}"
            ;;
        *)
            POSITIONAL+=("$arg")
            ;;
    esac
done

# Handle positional args based on broadcast mode
if [ "$BROADCAST" = true ]; then
    TYPE="${POSITIONAL[0]}"
    PAYLOAD="${POSITIONAL[1]}"
    TO=""
else
    TO="${POSITIONAL[0]}"
    TYPE="${POSITIONAL[1]}"
    PAYLOAD="${POSITIONAL[2]}"
fi

# Validate
if [ -z "$TYPE" ] || [ -z "$PAYLOAD" ]; then
    echo "Usage: mb-send <to> <type> <payload> [--urgent] [--priority=N]"
    echo "       mb-send --broadcast <type> <payload> [--urgent]"
    exit 1
fi

FROM="${CLAUDE_SESSION_ID:-system3}"
DB_FILE="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/queue.db"
SIGNAL_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/message-bus/signals"

# Ensure DB exists
if [ ! -f "$DB_FILE" ]; then
    echo "Error: Message bus not initialized. Run mb-init first."
    exit 1
fi

# Escape payload for SQL (replace single quotes)
ESCAPED_PAYLOAD=$(echo "$PAYLOAD" | sed "s/'/''/g")

# Insert message
if [ -z "$TO" ]; then
    sqlite3 "$DB_FILE" "INSERT INTO messages (from_instance, to_instance, message_type, priority, payload)
        VALUES ('$FROM', NULL, '$TYPE', $PRIORITY, '$ESCAPED_PAYLOAD')"
else
    sqlite3 "$DB_FILE" "INSERT INTO messages (from_instance, to_instance, message_type, priority, payload)
        VALUES ('$FROM', '$TO', '$TYPE', $PRIORITY, '$ESCAPED_PAYLOAD')"
fi

MSG_ID=$(sqlite3 "$DB_FILE" "SELECT last_insert_rowid()")

# Log the send
sqlite3 "$DB_FILE" "INSERT INTO message_log (message_id, event, instance_id, details)
    VALUES ($MSG_ID, 'sent', '$FROM', 'to=${TO:-broadcast} type=$TYPE priority=$PRIORITY urgent=$URGENT')"

# Touch signal file(s) and optionally inject via tmux
if [ -z "$TO" ]; then
    # Broadcast - signal all active orchestrators
    ORCHS=$(sqlite3 "$DB_FILE" "SELECT instance_id FROM orchestrators WHERE status='active'" 2>/dev/null || echo "")
    if [ -n "$ORCHS" ]; then
        for orch in $ORCHS; do
            touch "$SIGNAL_DIR/${orch}.signal"
            echo "$FROM|$TYPE|$PAYLOAD" > "$SIGNAL_DIR/${orch}.msg"

            # Urgent: tmux inject
            if [ "$URGENT" = true ]; then
                TMUX_SESSION=$(sqlite3 "$DB_FILE" "SELECT tmux_session FROM orchestrators WHERE instance_id='$orch'" 2>/dev/null || echo "")
                if [ -n "$TMUX_SESSION" ] && tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
                    tmux send-keys -t "$TMUX_SESSION" "/check-messages"
                    tmux send-keys -t "$TMUX_SESSION" Enter
                fi
            fi
        done
        echo "Message $MSG_ID broadcast to $(echo "$ORCHS" | wc -w | tr -d ' ') orchestrators (urgent=$URGENT)"
    else
        echo "Message $MSG_ID queued for broadcast (no active orchestrators)"
    fi
else
    # Targeted - signal specific orchestrator
    touch "$SIGNAL_DIR/${TO}.signal"
    echo "$FROM|$TYPE|$PAYLOAD" > "$SIGNAL_DIR/${TO}.msg"

    # Urgent: tmux inject
    if [ "$URGENT" = true ]; then
        TMUX_SESSION=$(sqlite3 "$DB_FILE" "SELECT tmux_session FROM orchestrators WHERE instance_id='$TO'" 2>/dev/null || echo "")
        if [ -n "$TMUX_SESSION" ] && tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
            tmux send-keys -t "$TMUX_SESSION" "/check-messages"
            tmux send-keys -t "$TMUX_SESSION" Enter
            echo "Message $MSG_ID sent to $TO with tmux injection (urgent)"
        else
            echo "Message $MSG_ID sent to $TO (urgent=$URGENT, tmux session not found)"
        fi
    else
        echo "Message $MSG_ID sent to $TO"
    fi
fi
