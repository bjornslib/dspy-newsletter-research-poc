#!/bin/bash
# cs-status - Show completion state overview
#
# Usage:
#   cs-status                    # Show all promises and session info
#   cs-status --mine             # Show only promises owned by current session
#   cs-status --orphans          # Show orphaned promises
#   cs-status --history          # Show verified/cancelled promises
#   cs-status --json             # Output as JSON
#
# Environment:
#   CLAUDE_SESSION_ID - Current session identifier (set via cs-init)

set -e

STATE_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/completion-state"
PROMISES_DIR="$STATE_DIR/promises"
HISTORY_DIR="$STATE_DIR/history"

JSON_OUTPUT=false
SHOW_MINE=false
SHOW_ORPHANS=false
SHOW_HISTORY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --mine)
            SHOW_MINE=true
            shift
            ;;
        --orphans)
            SHOW_ORPHANS=true
            shift
            ;;
        --history)
            SHOW_HISTORY=true
            shift
            ;;
        --help)
            echo "cs-status - Show completion state overview"
            echo ""
            echo "Usage:"
            echo "  cs-status              Show all active promises"
            echo "  cs-status --mine       Show only my promises"
            echo "  cs-status --orphans    Show orphaned promises"
            echo "  cs-status --history    Show completed promises"
            echo "  cs-status --json       Output as JSON"
            echo ""
            echo "Environment:"
            echo "  CLAUDE_SESSION_ID  Current session (set via: eval \"\$(cs-init)\")"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Run 'cs-status --help' for usage." >&2
            exit 1
            ;;
    esac
done

# Ensure directories exist
mkdir -p "$PROMISES_DIR"
mkdir -p "$HISTORY_DIR"

# JSON output mode
if [ "$JSON_OUTPUT" = true ]; then
    PROMISES="[]"
    HISTORY="[]"

    # Collect active promises
    if [ -d "$PROMISES_DIR" ] && [ -n "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            PROMISES=$(echo "$PROMISES" | jq --slurpfile p "$f" '. + $p')
        done
    fi

    # Collect history
    if [ -d "$HISTORY_DIR" ] && [ -n "$(ls -A "$HISTORY_DIR" 2>/dev/null)" ]; then
        for f in "$HISTORY_DIR"/*.json; do
            [ -f "$f" ] || continue
            # Only include promise files, not old session files
            if jq -e '.id | startswith("promise-")' "$f" >/dev/null 2>&1; then
                HISTORY=$(echo "$HISTORY" | jq --slurpfile p "$f" '. + $p')
            fi
        done
    fi

    jq -n \
        --arg session "${CLAUDE_SESSION_ID:-null}" \
        --argjson promises "$PROMISES" \
        --argjson history "$HISTORY" \
        '{
            session_id: $session,
            promises: $promises,
            history: $history
        }'
    exit 0
fi

# Human-readable output
echo "=================================================="
echo "COMPLETION STATE"
echo "=================================================="
echo ""

# Session info
if [ -n "$CLAUDE_SESSION_ID" ]; then
    echo "Current Session: $CLAUDE_SESSION_ID"
else
    echo "Current Session: (not set - run: eval \"\$(cs-init)\")"
fi
echo ""

# Show history if requested
if [ "$SHOW_HISTORY" = true ]; then
    echo "HISTORY (Verified/Cancelled):"
    echo ""

    if [ ! -d "$HISTORY_DIR" ] || [ -z "$(ls -A "$HISTORY_DIR" 2>/dev/null)" ]; then
        echo "  (no history)"
    else
        for f in "$HISTORY_DIR"/*.json; do
            [ -f "$f" ] || continue
            # Only show promise files, not old session files
            if jq -e '.id | startswith("promise-")' "$f" >/dev/null 2>&1; then
                ID=$(jq -r '.id' "$f")
                STATUS=$(jq -r '.status' "$f")
                SUMMARY=$(jq -r '.summary' "$f" | head -c 50)
                VERIFIED_BY=$(jq -r '.verification.verified_by // "n/a"' "$f")
                VERIFIED_AT=$(jq -r '.verification.verified_at // "n/a"' "$f")

                echo "  [$STATUS] $ID"
                echo "    \"$SUMMARY...\""
                if [ "$STATUS" = "verified" ]; then
                    echo "    Verified by: $VERIFIED_BY at $VERIFIED_AT"
                fi
                echo ""
            fi
        done
    fi
    exit 0
fi

# Count promises
TOTAL=0
MY_COUNT=0
ORPHAN_COUNT=0
IN_PROGRESS=0
PENDING=0

if [ -d "$PROMISES_DIR" ] && [ -n "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
    for f in "$PROMISES_DIR"/*.json; do
        [ -f "$f" ] || continue
        TOTAL=$((TOTAL + 1))

        OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
        STATUS=$(jq -r '.status' "$f")

        if [ "$OWNER" = "null" ]; then
            ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
        elif [ -n "$CLAUDE_SESSION_ID" ] && [ "$OWNER" = "$CLAUDE_SESSION_ID" ]; then
            MY_COUNT=$((MY_COUNT + 1))
        fi

        if [ "$STATUS" = "in_progress" ]; then
            IN_PROGRESS=$((IN_PROGRESS + 1))
        elif [ "$STATUS" = "pending" ]; then
            PENDING=$((PENDING + 1))
        fi
    done
fi

echo "Summary: $TOTAL active promise(s)"
if [ -n "$CLAUDE_SESSION_ID" ]; then
    echo "  - My promises: $MY_COUNT"
fi
echo "  - In progress: $IN_PROGRESS"
echo "  - Pending: $PENDING"
echo "  - Orphaned: $ORPHAN_COUNT"
echo ""

# Show orphans only
if [ "$SHOW_ORPHANS" = true ]; then
    echo "ORPHANED PROMISES:"
    echo ""

    if [ $ORPHAN_COUNT -eq 0 ]; then
        echo "  (no orphaned promises)"
    else
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            if [ "$OWNER" = "null" ]; then
                ID=$(jq -r '.id' "$f")
                STATUS=$(jq -r '.status' "$f")
                SUMMARY=$(jq -r '.summary' "$f" | head -c 50)
                CREATED_BY=$(jq -r '.ownership.created_by' "$f")

                echo "  [$STATUS] $ID"
                echo "    \"$SUMMARY...\""
                echo "    Created by: $CREATED_BY"
                echo ""
            fi
        done
    fi
    exit 0
fi

# Show my promises only
if [ "$SHOW_MINE" = true ]; then
    if [ -z "$CLAUDE_SESSION_ID" ]; then
        echo "Error: CLAUDE_SESSION_ID not set. Run: eval \"\$(cs-init)\"" >&2
        exit 1
    fi

    echo "MY PROMISES:"
    echo ""

    if [ $MY_COUNT -eq 0 ]; then
        echo "  (no promises owned by this session)"
    else
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            if [ "$OWNER" = "$CLAUDE_SESSION_ID" ]; then
                ID=$(jq -r '.id' "$f")
                STATUS=$(jq -r '.status' "$f")
                SUMMARY=$(jq -r '.summary' "$f" | head -c 60)

                case $STATUS in
                    pending)     STATUS_FMT="[PENDING]" ;;
                    in_progress) STATUS_FMT="[IN_PROGRESS]" ;;
                    *)           STATUS_FMT="[$STATUS]" ;;
                esac

                echo "  $STATUS_FMT $ID"
                echo "    \"$SUMMARY\""
                echo ""
            fi
        done
    fi
    exit 0
fi

# Show all promises
echo "ACTIVE PROMISES:"
echo ""

if [ $TOTAL -eq 0 ]; then
    echo "  (no active promises)"
else
    for f in "$PROMISES_DIR"/*.json; do
        [ -f "$f" ] || continue
        ID=$(jq -r '.id' "$f")
        STATUS=$(jq -r '.status' "$f")
        OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
        SUMMARY=$(jq -r '.summary' "$f" | head -c 50)

        case $STATUS in
            pending)     STATUS_FMT="[PENDING]" ;;
            in_progress) STATUS_FMT="[IN_PROGRESS]" ;;
            *)           STATUS_FMT="[$STATUS]" ;;
        esac

        if [ "$OWNER" = "null" ]; then
            OWNER_FMT="(orphaned)"
        elif [ -n "$CLAUDE_SESSION_ID" ] && [ "$OWNER" = "$CLAUDE_SESSION_ID" ]; then
            OWNER_FMT="(mine)"
        else
            OWNER_FMT="(owner: $OWNER)"
        fi

        echo "  $STATUS_FMT $ID $OWNER_FMT"
        echo "    \"$SUMMARY...\""
        echo ""
    done
fi

echo "=================================================="
