#!/bin/bash
# cs-promise - Manage completion promises (UUID-based, multi-session aware)
#
# Usage:
#   cs-promise --create "Promise summary"     # Create new promise (owned by current session)
#   cs-promise --list                         # List all promises
#   cs-promise --mine                         # List promises owned by current session
#   cs-promise --show <id>                    # Show promise details
#   cs-promise --start <id>                   # Set promise status to in_progress
#   cs-promise --adopt <id>                   # Adopt an orphaned promise
#   cs-promise --release <id>                 # Release ownership (orphan the promise)
#   cs-promise --cancel <id>                  # Cancel a promise
#
# Promise status lifecycle: pending → in_progress → verified | cancelled
#
# Environment:
#   CLAUDE_SESSION_ID - Current session identifier (set via cs-init)

set -e

STATE_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/completion-state"
PROMISES_DIR="$STATE_DIR/promises"
HISTORY_DIR="$STATE_DIR/history"

# Require session ID for most operations
require_session_id() {
    if [ -z "$CLAUDE_SESSION_ID" ]; then
        echo "Error: CLAUDE_SESSION_ID not set. Run: eval \"\$(cs-init)\"" >&2
        exit 1
    fi
}

# Generate UUID for promise
generate_promise_id() {
    echo "promise-$(python3 -c 'import secrets; print(secrets.token_hex(4))')"
}

# Get current timestamp
get_timestamp() {
    python3 -c 'import datetime; print(datetime.datetime.now(datetime.UTC).strftime("%Y-%m-%dT%H:%M:%SZ"))'
}

# Parse arguments
MODE=""
PROMISE_ID=""
SUMMARY=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --create)
            MODE="create"
            SUMMARY="$2"
            shift 2
            ;;
        --list)
            MODE="list"
            shift
            ;;
        --mine)
            MODE="mine"
            shift
            ;;
        --show)
            MODE="show"
            PROMISE_ID="$2"
            shift 2
            ;;
        --start)
            MODE="start"
            PROMISE_ID="$2"
            shift 2
            ;;
        --adopt)
            MODE="adopt"
            PROMISE_ID="$2"
            shift 2
            ;;
        --release)
            MODE="release"
            PROMISE_ID="$2"
            shift 2
            ;;
        --cancel)
            MODE="cancel"
            PROMISE_ID="$2"
            shift 2
            ;;
        --help)
            echo "cs-promise - Manage completion promises"
            echo ""
            echo "Usage:"
            echo "  cs-promise --create \"Promise summary\"  Create new promise"
            echo "  cs-promise --list                      List all promises"
            echo "  cs-promise --mine                      List promises owned by current session"
            echo "  cs-promise --show <id>                 Show promise details"
            echo "  cs-promise --start <id>                Set status to in_progress"
            echo "  cs-promise --adopt <id>                Adopt an orphaned promise"
            echo "  cs-promise --release <id>              Release ownership"
            echo "  cs-promise --cancel <id>               Cancel a promise"
            echo ""
            echo "Status lifecycle: pending → in_progress → verified | cancelled"
            echo ""
            echo "Environment:"
            echo "  CLAUDE_SESSION_ID  Current session (set via: eval \"\$(cs-init)\")"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Run 'cs-promise --help' for usage." >&2
            exit 1
            ;;
    esac
done

if [ -z "$MODE" ]; then
    echo "No command specified. Run 'cs-promise --help' for usage." >&2
    exit 1
fi

# Ensure directories exist
mkdir -p "$PROMISES_DIR"
mkdir -p "$HISTORY_DIR"

case $MODE in
    create)
        require_session_id

        if [ -z "$SUMMARY" ]; then
            echo "Error: --create requires a summary" >&2
            exit 1
        fi

        PROMISE_ID=$(generate_promise_id)
        TIMESTAMP=$(get_timestamp)
        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"

        cat > "$PROMISE_FILE" << EOF
{
    "id": "$PROMISE_ID",
    "summary": $(echo "$SUMMARY" | jq -Rs .),
    "ownership": {
        "created_by": "$CLAUDE_SESSION_ID",
        "created_at": "$TIMESTAMP",
        "owned_by": "$CLAUDE_SESSION_ID",
        "owned_since": "$TIMESTAMP"
    },
    "status": "pending",
    "verification": {
        "verified_at": null,
        "verified_by": null,
        "type": null,
        "proof": null
    },
    "structure": {
        "epics": [],
        "goals": []
    }
}
EOF

        echo "Created promise: $PROMISE_ID"
        echo "  Summary: $SUMMARY"
        echo "  Owner: $CLAUDE_SESSION_ID"
        echo "  Status: pending"
        echo ""
        echo "Next: cs-promise --start $PROMISE_ID"
        ;;

    list)
        if [ ! -d "$PROMISES_DIR" ] || [ -z "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
            echo "No promises found."
            exit 0
        fi

        echo "PROMISES:"
        echo ""
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            ID=$(jq -r '.id' "$f")
            STATUS=$(jq -r '.status' "$f")
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            SUMMARY=$(jq -r '.summary' "$f" | head -c 60)

            # Format status with color-like indicators
            case $STATUS in
                pending)     STATUS_FMT="[PENDING]" ;;
                in_progress) STATUS_FMT="[IN_PROGRESS]" ;;
                verified)    STATUS_FMT="[VERIFIED]" ;;
                cancelled)   STATUS_FMT="[CANCELLED]" ;;
                *)           STATUS_FMT="[$STATUS]" ;;
            esac

            # Format owner
            if [ "$OWNER" = "null" ]; then
                OWNER_FMT="(orphaned)"
            else
                OWNER_FMT="(owner: $OWNER)"
            fi

            echo "  $STATUS_FMT $ID $OWNER_FMT"
            echo "    \"$SUMMARY\""
            echo ""
        done
        ;;

    mine)
        require_session_id

        if [ ! -d "$PROMISES_DIR" ] || [ -z "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
            echo "No promises found."
            exit 0
        fi

        echo "MY PROMISES (session: $CLAUDE_SESSION_ID):"
        echo ""
        FOUND=0
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            if [ "$OWNER" = "$CLAUDE_SESSION_ID" ]; then
                ID=$(jq -r '.id' "$f")
                STATUS=$(jq -r '.status' "$f")
                SUMMARY=$(jq -r '.summary' "$f" | head -c 60)

                case $STATUS in
                    pending)     STATUS_FMT="[PENDING]" ;;
                    in_progress) STATUS_FMT="[IN_PROGRESS]" ;;
                    verified)    STATUS_FMT="[VERIFIED]" ;;
                    cancelled)   STATUS_FMT="[CANCELLED]" ;;
                    *)           STATUS_FMT="[$STATUS]" ;;
                esac

                echo "  $STATUS_FMT $ID"
                echo "    \"$SUMMARY\""
                echo ""
                FOUND=$((FOUND + 1))
            fi
        done

        if [ $FOUND -eq 0 ]; then
            echo "  (no promises owned by this session)"
        fi
        ;;

    show)
        if [ -z "$PROMISE_ID" ]; then
            echo "Error: --show requires a promise ID" >&2
            exit 1
        fi

        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
        if [ ! -f "$PROMISE_FILE" ]; then
            echo "Error: Promise not found: $PROMISE_ID" >&2
            exit 1
        fi

        echo "PROMISE: $PROMISE_ID"
        echo ""
        jq -r '
            "Summary: \(.summary)",
            "",
            "Ownership:",
            "  Created by: \(.ownership.created_by)",
            "  Created at: \(.ownership.created_at)",
            "  Owned by: \(.ownership.owned_by // "null (orphaned)")",
            "  Owned since: \(.ownership.owned_since // "n/a")",
            "",
            "Status: \(.status)",
            "",
            "Verification:",
            "  Verified at: \(.verification.verified_at // "not verified")",
            "  Verified by: \(.verification.verified_by // "n/a")",
            "  Type: \(.verification.type // "n/a")",
            "  Proof: \(.verification.proof // "n/a")"
        ' "$PROMISE_FILE"
        ;;

    start)
        require_session_id

        if [ -z "$PROMISE_ID" ]; then
            echo "Error: --start requires a promise ID" >&2
            exit 1
        fi

        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
        if [ ! -f "$PROMISE_FILE" ]; then
            echo "Error: Promise not found: $PROMISE_ID" >&2
            exit 1
        fi

        # Check ownership
        OWNER=$(jq -r '.ownership.owned_by // "null"' "$PROMISE_FILE")
        if [ "$OWNER" != "$CLAUDE_SESSION_ID" ]; then
            echo "Error: You don't own this promise. Current owner: $OWNER" >&2
            echo "Use --adopt to claim an orphaned promise." >&2
            exit 1
        fi

        # Check current status
        CURRENT_STATUS=$(jq -r '.status' "$PROMISE_FILE")
        if [ "$CURRENT_STATUS" != "pending" ]; then
            echo "Error: Can only start a pending promise. Current status: $CURRENT_STATUS" >&2
            exit 1
        fi

        # Update status
        jq '.status = "in_progress"' "$PROMISE_FILE" > "$PROMISE_FILE.tmp" && mv "$PROMISE_FILE.tmp" "$PROMISE_FILE"

        echo "Started promise: $PROMISE_ID"
        echo "  Status: in_progress"
        echo ""
        echo "When complete, run: cs-verify --promise $PROMISE_ID --proof \"...\""
        ;;

    adopt)
        require_session_id

        if [ -z "$PROMISE_ID" ]; then
            echo "Error: --adopt requires a promise ID" >&2
            exit 1
        fi

        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
        if [ ! -f "$PROMISE_FILE" ]; then
            echo "Error: Promise not found: $PROMISE_ID" >&2
            exit 1
        fi

        # Check if orphaned
        OWNER=$(jq -r '.ownership.owned_by // "null"' "$PROMISE_FILE")
        if [ "$OWNER" != "null" ]; then
            echo "Error: Promise is not orphaned. Current owner: $OWNER" >&2
            echo "Ask the owner to release it first." >&2
            exit 1
        fi

        TIMESTAMP=$(get_timestamp)

        # Update ownership
        jq --arg session "$CLAUDE_SESSION_ID" --arg ts "$TIMESTAMP" '
            .ownership.owned_by = $session |
            .ownership.owned_since = $ts
        ' "$PROMISE_FILE" > "$PROMISE_FILE.tmp" && mv "$PROMISE_FILE.tmp" "$PROMISE_FILE"

        echo "Adopted promise: $PROMISE_ID"
        echo "  New owner: $CLAUDE_SESSION_ID"
        ;;

    release)
        require_session_id

        if [ -z "$PROMISE_ID" ]; then
            echo "Error: --release requires a promise ID" >&2
            exit 1
        fi

        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
        if [ ! -f "$PROMISE_FILE" ]; then
            echo "Error: Promise not found: $PROMISE_ID" >&2
            exit 1
        fi

        # Check ownership
        OWNER=$(jq -r '.ownership.owned_by // "null"' "$PROMISE_FILE")
        if [ "$OWNER" != "$CLAUDE_SESSION_ID" ]; then
            echo "Error: You don't own this promise. Current owner: $OWNER" >&2
            exit 1
        fi

        # Update ownership to null (orphaned)
        jq '
            .ownership.owned_by = null |
            .ownership.owned_since = null
        ' "$PROMISE_FILE" > "$PROMISE_FILE.tmp" && mv "$PROMISE_FILE.tmp" "$PROMISE_FILE"

        echo "Released promise: $PROMISE_ID"
        echo "  Status: orphaned (no owner)"
        echo "  Another session can adopt it with: cs-promise --adopt $PROMISE_ID"
        ;;

    cancel)
        require_session_id

        if [ -z "$PROMISE_ID" ]; then
            echo "Error: --cancel requires a promise ID" >&2
            exit 1
        fi

        PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
        if [ ! -f "$PROMISE_FILE" ]; then
            echo "Error: Promise not found: $PROMISE_ID" >&2
            exit 1
        fi

        # Check ownership
        OWNER=$(jq -r '.ownership.owned_by // "null"' "$PROMISE_FILE")
        if [ "$OWNER" != "$CLAUDE_SESSION_ID" ]; then
            echo "Error: You don't own this promise. Current owner: $OWNER" >&2
            exit 1
        fi

        TIMESTAMP=$(get_timestamp)

        # Update status to cancelled and move to history
        jq --arg ts "$TIMESTAMP" '
            .status = "cancelled" |
            .verification.verified_at = $ts
        ' "$PROMISE_FILE" > "$PROMISE_FILE.tmp" && mv "$PROMISE_FILE.tmp" "$PROMISE_FILE"

        mv "$PROMISE_FILE" "$HISTORY_DIR/"

        echo "Cancelled promise: $PROMISE_ID"
        echo "  Moved to history."
        ;;
esac
