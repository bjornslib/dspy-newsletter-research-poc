#!/bin/bash
# cs-verify - Verify completion promises and check session readiness
#
# Usage:
#   cs-verify --promise <id> --proof "Evidence of completion"
#   cs-verify --promise <id> --type test --proof "All tests pass"
#   cs-verify --check                      # Check if session can end (for StopHook)
#   cs-verify --check --verbose            # Detailed check output
#
# Verification types:
#   test     - Verified via automated tests
#   browser  - Verified via browser/E2E testing
#   api      - Verified via API testing
#   manual   - Verified manually by user
#
# After verification, the promise is moved to history.
#
# Environment:
#   CLAUDE_SESSION_ID - Current session identifier (set via cs-init)

set -e

STATE_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}/.claude/completion-state"
PROMISES_DIR="$STATE_DIR/promises"
HISTORY_DIR="$STATE_DIR/history"

# Require session ID
require_session_id() {
    if [ -z "$CLAUDE_SESSION_ID" ]; then
        echo "Error: CLAUDE_SESSION_ID not set. Run: eval \"\$(cs-init)\"" >&2
        exit 1
    fi
}

# Get current timestamp
get_timestamp() {
    python3 -c 'import datetime; print(datetime.datetime.now(datetime.UTC).strftime("%Y-%m-%dT%H:%M:%SZ"))'
}

# Parse arguments
MODE=""
PROMISE_ID=""
PROOF=""
VERIFY_TYPE="manual"
CHECK_MODE=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --promise)
            MODE="verify"
            PROMISE_ID="$2"
            shift 2
            ;;
        --proof)
            PROOF="$2"
            shift 2
            ;;
        --type)
            VERIFY_TYPE="$2"
            shift 2
            ;;
        --check)
            CHECK_MODE=true
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --help)
            echo "cs-verify - Verify completion promises"
            echo ""
            echo "Usage:"
            echo "  cs-verify --promise <id> --proof \"Evidence\""
            echo "  cs-verify --promise <id> --type test --proof \"All tests pass\""
            echo "  cs-verify --check             Check if session can end"
            echo "  cs-verify --check --verbose   Detailed check output"
            echo ""
            echo "Options:"
            echo "  --promise <id>   Promise ID to verify"
            echo "  --proof <text>   Evidence of completion"
            echo "  --type <type>    Verification type: test, browser, api, manual (default: manual)"
            echo "  --check          Evaluate if session can end (for StopHook)"
            echo "  --verbose        Show detailed output"
            echo ""
            echo "Exit codes for --check:"
            echo "  0  Session can end (all owned promises verified)"
            echo "  2  Session cannot end (unverified promises remain)"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Run 'cs-verify --help' for usage." >&2
            exit 1
            ;;
    esac
done

# Ensure directories exist
mkdir -p "$PROMISES_DIR"
mkdir -p "$HISTORY_DIR"

# Handle --check mode (for StopHook)
if [ "$CHECK_MODE" = true ]; then
    require_session_id

    # Find all promises owned by this session
    MY_PROMISES=()
    IN_PROGRESS_COUNT=0
    PENDING_COUNT=0

    if [ -d "$PROMISES_DIR" ] && [ -n "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            if [ "$OWNER" = "$CLAUDE_SESSION_ID" ]; then
                ID=$(jq -r '.id' "$f")
                STATUS=$(jq -r '.status' "$f")
                SUMMARY=$(jq -r '.summary' "$f" | head -c 50)
                MY_PROMISES+=("$ID:$STATUS:$SUMMARY")

                if [ "$STATUS" = "in_progress" ]; then
                    IN_PROGRESS_COUNT=$((IN_PROGRESS_COUNT + 1))
                elif [ "$STATUS" = "pending" ]; then
                    PENDING_COUNT=$((PENDING_COUNT + 1))
                fi
            fi
        done
    fi

    # Check for orphaned in_progress promises (warn but don't block)
    ORPHAN_COUNT=0
    if [ -d "$PROMISES_DIR" ] && [ -n "$(ls -A "$PROMISES_DIR" 2>/dev/null)" ]; then
        for f in "$PROMISES_DIR"/*.json; do
            [ -f "$f" ] || continue
            OWNER=$(jq -r '.ownership.owned_by // "null"' "$f")
            STATUS=$(jq -r '.status' "$f")
            if [ "$OWNER" = "null" ] && [ "$STATUS" = "in_progress" ]; then
                ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
                if [ "$VERBOSE" = true ]; then
                    ID=$(jq -r '.id' "$f")
                    SUMMARY=$(jq -r '.summary' "$f" | head -c 50)
                    echo "WARNING: Orphaned in_progress promise: $ID" >&2
                    echo "  \"$SUMMARY...\"" >&2
                fi
            fi
        done
    fi

    # No owned promises = can exit
    if [ ${#MY_PROMISES[@]} -eq 0 ]; then
        if [ "$VERBOSE" = true ]; then
            echo "No promises owned by this session."
        fi
        if [ $ORPHAN_COUNT -gt 0 ]; then
            echo "WARNING: $ORPHAN_COUNT orphaned in_progress promise(s) detected." >&2
            echo "Run 'cs-promise --list' to see them." >&2
        fi
        exit 0
    fi

    # All owned promises are verified/cancelled = can exit
    if [ $IN_PROGRESS_COUNT -eq 0 ] && [ $PENDING_COUNT -eq 0 ]; then
        if [ "$VERBOSE" = true ]; then
            echo "All owned promises are complete."
        fi
        exit 0
    fi

    # Have unverified promises - block exit
    echo "COMPLETION CRITERIA NOT MET"
    echo ""
    echo "Session: $CLAUDE_SESSION_ID"
    echo ""

    if [ $IN_PROGRESS_COUNT -gt 0 ]; then
        echo "IN_PROGRESS PROMISES ($IN_PROGRESS_COUNT):"
        for entry in "${MY_PROMISES[@]}"; do
            IFS=':' read -r ID STATUS SUMMARY <<< "$entry"
            if [ "$STATUS" = "in_progress" ]; then
                echo "  $ID: \"$SUMMARY...\""
            fi
        done
        echo ""
    fi

    if [ $PENDING_COUNT -gt 0 ]; then
        echo "PENDING PROMISES ($PENDING_COUNT):"
        for entry in "${MY_PROMISES[@]}"; do
            IFS=':' read -r ID STATUS SUMMARY <<< "$entry"
            if [ "$STATUS" = "pending" ]; then
                echo "  $ID: \"$SUMMARY...\""
            fi
        done
        echo ""
    fi

    echo "NEXT ACTION:"
    # Find first in_progress or pending promise
    for entry in "${MY_PROMISES[@]}"; do
        IFS=':' read -r ID STATUS SUMMARY <<< "$entry"
        if [ "$STATUS" = "in_progress" ]; then
            echo "  Complete and verify: cs-verify --promise $ID --proof \"...\""
            break
        elif [ "$STATUS" = "pending" ]; then
            echo "  Start work: cs-promise --start $ID"
            break
        fi
    done

    if [ $ORPHAN_COUNT -gt 0 ]; then
        echo ""
        echo "WARNING: $ORPHAN_COUNT orphaned in_progress promise(s) detected."
        echo "Consider adopting or investigating crashed sessions."
    fi

    # Exit 2 to block stop
    exit 2
fi

# Handle verification mode
if [ "$MODE" != "verify" ]; then
    echo "Error: Must specify --promise or --check" >&2
    exit 1
fi

require_session_id

if [ -z "$PROMISE_ID" ]; then
    echo "Error: --promise requires an ID" >&2
    exit 1
fi

if [ -z "$PROOF" ]; then
    echo "Error: --proof is required for verification" >&2
    exit 1
fi

# Validate verification type
case $VERIFY_TYPE in
    test|browser|api|manual) ;;
    *)
        echo "Error: Invalid verification type: $VERIFY_TYPE" >&2
        echo "Valid types: test, browser, api, manual" >&2
        exit 1
        ;;
esac

PROMISE_FILE="$PROMISES_DIR/$PROMISE_ID.json"
if [ ! -f "$PROMISE_FILE" ]; then
    echo "Error: Promise not found: $PROMISE_ID" >&2
    exit 1
fi

# Check ownership
OWNER=$(jq -r '.ownership.owned_by // "null"' "$PROMISE_FILE")
if [ "$OWNER" != "$CLAUDE_SESSION_ID" ]; then
    echo "Error: You don't own this promise. Current owner: $OWNER" >&2
    echo "Use 'cs-promise --adopt $PROMISE_ID' to claim it first." >&2
    exit 1
fi

# Check current status
CURRENT_STATUS=$(jq -r '.status' "$PROMISE_FILE")
if [ "$CURRENT_STATUS" = "verified" ]; then
    echo "Error: Promise is already verified." >&2
    exit 1
fi

if [ "$CURRENT_STATUS" = "cancelled" ]; then
    echo "Error: Cannot verify a cancelled promise." >&2
    exit 1
fi

if [ "$CURRENT_STATUS" = "pending" ]; then
    echo "Note: Promise was pending. Setting to in_progress before verifying." >&2
fi

TIMESTAMP=$(get_timestamp)
SUMMARY=$(jq -r '.summary' "$PROMISE_FILE")

# Update promise with verification
jq --arg ts "$TIMESTAMP" \
   --arg session "$CLAUDE_SESSION_ID" \
   --arg type "$VERIFY_TYPE" \
   --arg proof "$PROOF" '
    .status = "verified" |
    .verification.verified_at = $ts |
    .verification.verified_by = $session |
    .verification.type = $type |
    .verification.proof = $proof
' "$PROMISE_FILE" > "$PROMISE_FILE.tmp" && mv "$PROMISE_FILE.tmp" "$PROMISE_FILE"

# Move to history
mv "$PROMISE_FILE" "$HISTORY_DIR/"

echo "VERIFIED: $PROMISE_ID"
echo ""
echo "Summary: $SUMMARY"
echo "Type: $VERIFY_TYPE"
echo "Proof: $PROOF"
echo "Verified by: $CLAUDE_SESSION_ID"
echo "Verified at: $TIMESTAMP"
echo ""
echo "Promise moved to history."
