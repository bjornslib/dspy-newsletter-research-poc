# Completion Promise Protocol Reference

File-based state tracking that ensures sessions only complete when user goals are verifiably achieved.

---

## Core Concept

Every session has a **Completion Promise** - verifiable success criteria extracted from the user's initial request. The session cannot end until these criteria are met.

```
User Prompt --> Extract Goals --> Track Progress --> Verify Completion --> Allow Stop
```

**Why This Matters**: The stop hook (`completion-gate.py`) enforces this - if criteria aren't met, the session cannot end.

---

## Session ID: Auto-Generated by ccsystem3

**For main System 3 sessions**: `CLAUDE_SESSION_ID` is **automatically set** by the `ccsystem3` shell function. You do NOT need to run `cs-init`.

**For tmux-spawned orchestrators**: You must set `CLAUDE_SESSION_ID` manually before launching Claude Code:
```bash
export CLAUDE_SESSION_ID="orch-[name]"
```

**Verify your session ID:**
```bash
echo $CLAUDE_SESSION_ID
```

---

## CLI Scripts Location

All scripts are in `.claude/scripts/completion-state/`:

| Command | Purpose |
|---------|---------|
| `cs-promise --create "..."` | Create new promise owned by current session |
| `cs-promise --list` | List all promises with ownership |
| `cs-promise --mine` | List only my promises |
| `cs-promise --start <id>` | Set promise to in_progress |
| `cs-promise --adopt <id>` | Adopt orphaned promise |
| `cs-promise --release <id>` | Release ownership (orphan) |
| `cs-verify --promise <id> --proof "..."` | Verify and complete promise |
| `cs-verify --check` | Check if session can end |
| `cs-status` | Show completion state overview |

---

## Session Initialization Workflow

### Step 1: Verify Session ID

For main System 3 sessions, `CLAUDE_SESSION_ID` is already set by `ccsystem3`:

```bash
# Verify it's set
echo $CLAUDE_SESSION_ID
```

For tmux-spawned orchestrators, set it manually before launching Claude:
```bash
export CLAUDE_SESSION_ID="orch-[name]"
```

### Step 2: Extract Goals from User Prompt

```bash
# From the user's first message
.claude/scripts/completion-state/cs-extract --prompt "User's original prompt..."
```

Or with explicit goals:

```bash
.claude/scripts/completion-state/cs-extract \
    --goal "Goal description" \
    --criteria "Criterion 1" \
    --criteria "Criterion 2"
```

### Step 3: For PRD-based Work

```bash
# Link PRD and extract structure
.claude/scripts/completion-state/cs-extract --prd ".taskmaster/docs/epic-prd.md"

# Add epics
.claude/scripts/completion-state/cs-add-epic --id E1 --title "Epic title"

# Add features with criteria
.claude/scripts/completion-state/cs-add-feature \
    --epic E1 \
    --id F1.1 \
    --title "Feature" \
    --criteria "Must do X" \
    --criteria "Must pass Y test"
```

### Step 4: Set Summary

```bash
.claude/scripts/completion-state/cs-update --summary "One-line completion promise"
```

---

## During Work: Status Updates

### Mark Feature In Progress

```bash
.claude/scripts/completion-state/cs-update --feature F1.1 --status in_progress
```

### Record Verification Proof

**CRITICAL**: Verification needs evidence, not just assertions.

```bash
.claude/scripts/completion-state/cs-verify \
    --feature F1.1 \
    --type test \
    --command "pytest tests/test_feature.py -v" \
    --proof "All 5 tests passed"
```

Verification types:
- `test` - Automated tests
- `api` - API endpoint verification
- `browser` - E2E browser verification
- `manual` - Manual verification (least preferred)

### Log Progress with Learnings

```bash
.claude/scripts/completion-state/cs-update --log \
    --action "Implemented voicemail detection" \
    --outcome success \
    --learning "AMD detection requires 3-second silence threshold"
```

### Add Discovered Codebase Patterns

```bash
.claude/scripts/completion-state/cs-update --pattern "Migrations: Use IF NOT EXISTS"
```

---

## Stop Hook Integration

The `completion-gate.py` hook automatically evaluates completion criteria:

| Exit Code | Meaning | Result |
|-----------|---------|--------|
| 0 | All criteria verified | Session can end |
| 2 | Criteria not met | Session blocked |

### When Blocked

You'll see a message like:

```
STOP BLOCKED: COMPLETION PROMISE UNMET

INCOMPLETE GOALS (1 remaining):
  [in_progress] G2: Voice agent retries calls

NEXT ACTION:
  Continue working on goal G2
```

**Response**: Continue working - don't try to force the stop.

---

## Checking Status

### Full Status Overview

```bash
.claude/scripts/completion-state/cs-status
```

### JSON for Programmatic Access

```bash
.claude/scripts/completion-state/cs-status --json
```

### Check If Session Can End

```bash
.claude/scripts/completion-state/cs-check
```

---

## Session State JSON Schema

```json
{
  "session_id": "string",
  "summary": "One-line completion promise",
  "goals": [
    {
      "id": "G1",
      "description": "string",
      "criteria": ["criterion 1", "criterion 2"],
      "status": "pending|in_progress|passed|failed"
    }
  ],
  "epics": [
    {
      "id": "E1",
      "title": "string",
      "features": [
        {
          "id": "F1.1",
          "title": "string",
          "criteria": ["string"],
          "status": "pending|in_progress|passed|failed",
          "verification": {
            "type": "test|api|browser|manual",
            "command": "string",
            "proof": "string"
          }
        }
      ]
    }
  ],
  "progress_log": [
    {
      "timestamp": "ISO8601",
      "action": "string",
      "outcome": "success|failure|blocked",
      "learning": "string (optional)"
    }
  ],
  "codebase_patterns": ["string"]
}
```

---

## Verification Sub-Agent Pattern

For thorough verification, spawn a dedicated agent:

```python
Task(
    subagent_type="general-purpose",
    model="sonnet",
    description="Verify completion criteria",
    prompt="""
    Read .claude/completion-state/session-state.json

    For each item marked 'passed':
    1. Verify the proof is valid
    2. Run verification command if provided
    3. Confirm criteria actually met

    Report VERIFIED, FAILED, or NEEDS_VERIFICATION for each.
    Update session-state.json with findings.
    """
)
```

---

## Integration with Orchestrators

When spawning orchestrators, inject completion context:

```python
# Get current completion state
completion_context = Bash(".claude/scripts/completion-state/cs-status --json")

# Include in wisdom injection
wisdom = f"""
## Active Completion Promise
{completion_context}

Report completion with verification proof using cs-verify.
"""
```

---

## Quick Reference

| Phase | Commands |
|-------|----------|
| **Session Start** | Verify `$CLAUDE_SESSION_ID` is set, then `cs-promise --create` |
| **During Work** | `cs-update`, `cs-verify`, `cs-status` |
| **Before Stop** | `cs-check` (automatic via hook) |

**Remember**: The completion promise is what the user asked for, not what you decided to do. Extract from their original request.

---

**Version**: 1.0.0
**Source**: System 3 Output Style - Completion Promise Protocol (Ralph Wiggum Pattern)
